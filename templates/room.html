
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Room</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>
<body>
    <div class="content">
        <div class="message-box">
            <h2>Chat Room: {{ code }}</h2>
            <div class="messages" id="messages"></div>
            <div class="inputs">
                <input type="text" rows="3" placeholder="Message" name="message" id="message"/>
                <button type="button" name="send" id="send-btn" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        var socketio = io();

        const messages = document.getElementById("messages");

        const createMessage = (name, msg, message_id) => {
            const content = `
                <div class="text" id="message_${message_id}">
                    <span>
                        <strong>${name}</strong>: ${msg}
                    </span>
                    <span class="muted">
                        <button onclick="updateMessage(${message_id})">Edit</button>
                        <button onclick="deleteMessage(${message_id})">Delete</button>
                    </span>
                </div>
            `;
            messages.innerHTML += content;
        };

        socketio.on("message", (data) => {
            createMessage(data.name, data.message, data.id);
        });

        socketio.on("message_updated", (data) => {
            const messageElement = document.getElementById(`message_${data.msg_id}`);
            if (messageElement) {
                messageElement.querySelector('span:first-child').innerHTML = `<strong>${data.name}</strong>: ${data.new_text}`;
            }
        });

        socketio.on("message_deleted", (data) => {
            const messageElement = document.getElementById(`message_${data.msg_id}`);
            if (messageElement) {
                messageElement.remove();
            }
        });

        const sendMessage = () => {
            const message = document.getElementById("message");
            if (message.value == "") return;
            socketio.emit("message", { message: message.value });
            message.value = "";
        };

        const updateMessage = (messageId) => {
            const newText = prompt("Enter new message:");
            if (newText !== null) {
                socketio.emit("update_message", { msg_id: messageId, text: newText });
            }
        };

        const deleteMessage = (messageId) => {
            if (confirm("Are you sure you want to delete this message?")) {
                socketio.emit("delete_message", { msg_id: messageId });
            }
        };

        // Render existing messages
        const initialMessages = JSON.parse('{{ messages | tojson | safe }}');
        initialMessages.forEach(msg => {
            createMessage(msg.name, msg.message, msg.id);
        });
    </script>
</body>
</html>